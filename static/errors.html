<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ pageTitle }}</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <script src="/web/i18n.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
      body {
        background: #0b0c10;
        color: #e7e9ea;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu,
          "Helvetica Neue", Arial;
      }
      .wrap {
        max-width: 1600px;
        margin: 18px auto;
        padding: 18px;
        background: #111418;
        border-radius: 14px;
      }
      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
      }
      .error-detail {
        max-height: 400px;
        overflow-y: auto;
        background: #1a1d23;
        padding: 12px;
        border-radius: 8px;
        margin-top: 10px;
      }
      .stack-trace {
        white-space: pre-wrap;
        word-break: break-all;
        font-size: 11px;
        color: #909399;
      }
      .lang-toggle {
        display: flex;
        gap: 5px;
      }
      .lang-btn {
        padding: 4px 12px;
        border: 1px solid #409eff;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        background: transparent;
        color: #409eff;
      }
      .lang-btn.active {
        background: #409eff;
        color: #fff;
      }
      .lang-btn:hover:not(.active) {
        background: rgba(64, 158, 255, 0.1);
      }
    </style>
  </head>
  <body>
    <div id="app" class="wrap">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <h2 style="margin: 0">{{ t.errorLogs }}</h2>
        <div style="display: flex; gap: 10px; align-items: center">
          <el-button @click="goToIndex" icon="Back"
            >{{ t.backToConsole }}</el-button
          >
          <div class="lang-toggle">
            <button
              class="lang-btn"
              :class="{ active: currentLang === 'zh' }"
              @click="switchLanguage('zh')"
            >
              中文
            </button>
            <button
              class="lang-btn"
              :class="{ active: currentLang === 'en' }"
              @click="switchLanguage('en')"
            >
              English
            </button>
          </div>
          <el-button @click="refreshLogs" icon="Refresh" :loading="loading"
            >{{ t.refresh }}</el-button
          >
          <el-popconfirm :title="t.clearConfirm" @confirm="clearLogs">
            <template #reference>
              <el-button type="danger" icon="Delete">{{ t.clear }}</el-button>
            </template>
          </el-popconfirm>
        </div>
      </div>

      <el-card shadow="never">
        <template #header>
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <b>{{ t.recentErrors }} ({{ t.last100 }})</b>
            <el-tag v-if="errorLogs.length === 0" type="success"
              >{{ t.noErrors }}</el-tag
            >
            <el-tag v-else type="warning"
              >{{ errorLogs.length }} {{ t.errors }}</el-tag
            >
          </div>
        </template>

        <el-table
          :data="errorLogs"
          size="small"
          style="width: 100%"
          v-loading="loading"
          @row-click="showDetail"
        >
          <el-table-column prop="id" label="ID" width="60"></el-table-column>

          <el-table-column :label="t.time" width="180">
            <template #default="s">
              {{ formatTime(s.row.timestamp) }}
            </template>
          </el-table-column>

          <el-table-column :label="t.level" width="80">
            <template #default="s">
              <el-tag v-if="s.row.level === 'FATAL'" type="danger" size="small"
                >FATAL</el-tag
              >
              <el-tag
                v-else-if="s.row.level === 'ERROR'"
                type="danger"
                size="small"
                effect="plain"
                >ERROR</el-tag
              >
              <el-tag v-else type="warning" size="small">WARN</el-tag>
            </template>
          </el-table-column>

          <el-table-column
            prop="source"
            :label="t.source"
            width="150"
          ></el-table-column>

          <el-table-column prop="message" :label="t.message" min-width="200">
            <template #default="s">
              <div
                style="
                  max-width: 400px;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                "
              >
                {{ s.row.message }}
              </div>
            </template>
          </el-table-column>

          <el-table-column :label="t.detail" min-width="200">
            <template #default="s">
              <div
                v-if="s.row.detail"
                style="
                  max-width: 400px;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                "
                class="code"
              >
                {{ s.row.detail }}
              </div>
              <span v-else style="color: #909399">-</span>
            </template>
          </el-table-column>

          <el-table-column :label="t.operation" width="100" fixed="right">
            <template #default="s">
              <el-button
                size="small"
                @click.stop="showDetail(s.row)"
                icon="View"
                >{{ t.view }}</el-button
              >
            </template>
          </el-table-column>
        </el-table>
      </el-card>

      <!-- 详情对话框 -->
      <el-dialog
        v-model="detailVisible"
        :title="t.errorDetail"
        width="80%"
        top="5vh"
      >
        <div v-if="selectedLog">
          <el-descriptions :column="2" border>
            <el-descriptions-item :label="t.id"
              >{{ selectedLog.id }}</el-descriptions-item
            >
            <el-descriptions-item :label="t.time"
              >{{ formatTime(selectedLog.timestamp) }}</el-descriptions-item
            >
            <el-descriptions-item :label="t.level">
              <el-tag v-if="selectedLog.level === 'FATAL'" type="danger"
                >FATAL</el-tag
              >
              <el-tag
                v-else-if="selectedLog.level === 'ERROR'"
                type="danger"
                effect="plain"
                >ERROR</el-tag
              >
              <el-tag v-else type="warning">WARN</el-tag>
            </el-descriptions-item>
            <el-descriptions-item :label="t.source"
              >{{ selectedLog.source }}</el-descriptions-item
            >
            <el-descriptions-item :label="t.message" :span="2">
              <div class="code">{{ selectedLog.message }}</div>
            </el-descriptions-item>
          </el-descriptions>

          <div
            v-if="selectedLog.detail"
            class="error-detail"
            style="margin-top: 15px"
          >
            <h4 style="margin: 0 0 10px 0">{{ t.detailInfo }}:</h4>
            <div class="code">{{ selectedLog.detail }}</div>
          </div>

          <div
            v-if="selectedLog.context"
            class="error-detail"
            style="margin-top: 15px"
          >
            <h4 style="margin: 0 0 10px 0">{{ t.context }}:</h4>
            <pre class="code">{{ formatJSON(selectedLog.context) }}</pre>
          </div>

          <div
            v-if="selectedLog.stack"
            class="error-detail"
            style="margin-top: 15px"
          >
            <h4 style="margin: 0 0 10px 0">{{ t.stackTrace }}:</h4>
            <div class="stack-trace">{{ selectedLog.stack }}</div>
          </div>
        </div>
      </el-dialog>
    </div>

    <script>
      const { createApp, ref, onMounted } = Vue;
      const { ElMessage } = ElementPlus;

      const app = createApp({
        setup() {
          const errorLogs = ref([]);
          const loading = ref(false);
          const detailVisible = ref(false);
          const selectedLog = ref(null);
          const currentLang = ref(i18n.getLanguage());
          const t = ref(i18n.getAll());

          const updateTitle = () => {
            document.title =
              currentLang.value === "zh"
                ? i18nConfig.zh.titleErrors
                : i18nConfig.en.titleErrors;
          };
          updateTitle();

          const loadErrorLogs = async () => {
            loading.value = true;
            try {
              const response = await fetch("/api/error-logs");
              errorLogs.value = await response.json();
            } catch (e) {
              ElMessage.error(
                currentLang.value === "zh" ? "加载失败" : "Load failed"
              );
            } finally {
              loading.value = false;
            }
          };

          const refreshLogs = async () => {
            await loadErrorLogs();
            ElMessage.success(
              currentLang.value === "zh" ? "刷新成功" : "Refreshed"
            );
          };

          const clearLogs = async () => {
            try {
              await fetch("/api/error-logs", { method: "DELETE" });
              await loadErrorLogs();
              ElMessage.success(
                currentLang.value === "zh" ? "清空成功" : "Cleared"
              );
            } catch (e) {
              ElMessage.error(
                currentLang.value === "zh" ? "清空失败" : "Clear failed"
              );
            }
          };

          const showDetail = (row) => {
            selectedLog.value = row;
            detailVisible.value = true;
          };

          const formatTime = (timestamp) => {
            const date = new Date(timestamp);
            const locale = currentLang.value === "zh" ? "zh-CN" : "en-US";
            return date.toLocaleString(locale, { hour12: false });
          };
          const formatJSON = (jsonStr) => {
            try {
              return JSON.stringify(JSON.parse(jsonStr), null, 2);
            } catch {
              return jsonStr;
            }
          };

          const goToIndex = () => {
            window.location.href = "/web/index.html";
          };

          const switchLanguage = (lang) => {
            updateTitle();
            i18n.setLanguage(lang);
            currentLang.value = lang;
            t.value = i18n.getAll();
          };

          onMounted(() => {
            loadErrorLogs();
          });

          return {
            errorLogs,
            loading,
            detailVisible,
            selectedLog,
            loadErrorLogs,
            refreshLogs,
            clearLogs,
            showDetail,
            formatTime,
            formatJSON,
            goToIndex,
            currentLang,
            t,
            switchLanguage,
          };
        },
      });

      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
      }
      app.use(ElementPlus).mount("#app");
    </script>
  </body>
</html>
