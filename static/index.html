<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ pageTitle }}</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/element-plus/dist/index.css"
    />
    <link rel="icon" href="/favicon.ico" type="image/x-icon" />
    <script src="/web/i18n.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
      body {
        background: #0b0c10;
        color: #e7e9ea;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu,
          "Helvetica Neue", Arial;
      }
      .wrap {
        max-width: 1600px;
        margin: 18px auto;
        padding: 18px;
        background: #111418;
        border-radius: 14px;
      }
      .muted {
        opacity: 0.75;
      }
      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
      }
      .el-table th .cell {
        white-space: nowrap;
        display: inline-block;
      }
      .op-vertical {
        display: flex;
        flexdirection: column;
        gap: 4px;
      }
      .traffic-info {
        font-size: 13px;
        line-height: 1.2;
      }
      .traffic-label {
        font-weight: bold;
        margin-right: 4px;
        color: #409eff;
      }
      /* 选中编辑时的卡片高亮 */
      .editing-card {
        border: 1px solid #409eff !important;
      }
      /* 语言切换按钮 */
      .lang-toggle {
        display: flex;
        gap: 5px;
      }
      .lang-btn {
        padding: 4px 12px;
        border: 1px solid #409eff;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s;
        background: transparent;
        color: #409eff;
      }
      .lang-btn.active {
        background: #409eff;
        color: #fff;
      }
      .lang-btn:hover:not(.active) {
        background: rgba(64, 158, 255, 0.1);
      }
    </style>
  </head>
  <body>
    <div id="app" class="wrap">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        "
      >
        <h2 style="margin: 0">{{ t.console }}</h2>
        <div style="display: flex; gap: 10px; align-items: center">
          <el-button @click="goToLogs" icon="Document"
            >{{ t.httpLogs }}</el-button
          >
          <el-button @click="goToErrors" icon="Warning" type="warning"
            >{{ t.errorLogs }}</el-button
          >
          <el-button
            @click="showShutdownDialog"
            icon="SwitchButton"
            type="danger"
            >{{ t.shutdown }}</el-button
          >
          <div class="lang-toggle">
            <button
              class="lang-btn"
              :class="{ active: currentLang === 'zh' }"
              @click="switchLanguage('zh')"
            >
              中文
            </button>
            <button
              class="lang-btn"
              :class="{ active: currentLang === 'en' }"
              @click="switchLanguage('en')"
            >
              English
            </button>
          </div>
          <el-button @click="refreshPage" icon="Refresh" circle></el-button>
        </div>
      </div>

      <el-row :gutter="24" style="margin-bottom: 16px">
        <el-col :span="6">
          <el-card shadow="never" :class="{ 'editing-card': isEditingBastion }">
            <template #header>
              <b>{{ isEditingBastion ? t.editBastion : t.addBastion }}</b>
              <el-button
                v-if="isEditingBastion"
                size="small"
                style="float: right"
                @click="resetBastionForm"
                >{{ t.cancel }}</el-button
              >
            </template>
            <el-form :model="bastionForm" label-width="60px" size="small">
              <el-form-item :label="t.host"
                ><el-input
                  v-model="bastionForm.host"
                  placeholder="1.2.3.4"
                ></el-input
              ></el-form-item>
              <el-form-item :label="t.port"
                ><el-input-number
                  v-model="bastionForm.port"
                  :min="1"
                  :max="65535"
                  style="width: 100%"
                ></el-input-number
              ></el-form-item>
              <el-form-item :label="t.username"
                ><el-input v-model="bastionForm.username"></el-input
              ></el-form-item>
              <el-form-item :label="t.password"
                ><el-input
                  v-model="bastionForm.password"
                  show-password
                ></el-input
              ></el-form-item>
              <el-form-item :label="t.privateKey"
                ><el-input
                  v-model="bastionForm.pkey_path"
                  placeholder="~/.ssh/id_rsa"
                ></el-input
              ></el-form-item>
              <el-form-item :label="t.passphrase"
                ><el-input
                  v-model="bastionForm.pkey_passphrase"
                  show-password
                ></el-input
              ></el-form-item>
              <el-form-item>
                <el-button
                  type="primary"
                  @click="submitBastion"
                  :disabled="!bastionForm.host"
                >
                  {{ isEditingBastion ? t.saveChanges : t.add }}
                </el-button>
                <el-button @click="resetBastionForm" v-if="!isEditingBastion"
                  >{{ t.reset }}</el-button
                >
              </el-form-item>
            </el-form>
          </el-card>
        </el-col>

        <el-col :span="18">
          <el-card shadow="never">
            <template #header><b>{{ t.bastionList }}</b></template>
            <el-table :data="bastions" size="small" style="width: 100%">
              <el-table-column
                prop="name"
                :label="t.identifier"
                width="200"
              ></el-table-column>
              <el-table-column prop="host" :label="t.address"></el-table-column>
              <el-table-column
                prop="username"
                :label="t.user"
                width="200"
              ></el-table-column>
              <el-table-column :label="t.auth" width="120">
                <template #default="s">
                  <el-tag v-if="s.row.pkey_path" size="small" type="success"
                    >Key</el-tag
                  >
                  <el-tag v-else-if="s.row.password" size="small" type="warning"
                    >Pwd</el-tag
                  >
                  <el-tag v-else size="small" type="info">None</el-tag>
                </template>
              </el-table-column>
              <el-table-column :label="t.operation" width="200">
                <template #default="s">
                  <div style="display: flex; gap: 5px">
                    <el-tooltip :content="t.editConfig" placement="top">
                      <el-button
                        size="small"
                        circle
                        icon="Edit"
                        @click="editBastion(s.row)"
                      ></el-button>
                    </el-tooltip>
                    <el-tooltip :content="t.copyConfig" placement="top">
                      <el-button
                        size="small"
                        circle
                        icon="DocumentCopy"
                        @click="copyBastion(s.row)"
                      ></el-button>
                    </el-tooltip>
                    <el-popconfirm
                      :title="t.deleteConfirm"
                      @confirm="delBastion(s.row.id)"
                    >
                      <template #reference>
                        <el-button
                          size="small"
                          type="danger"
                          circle
                          icon="Delete"
                        ></el-button>
                      </template>
                    </el-popconfirm>
                  </div>
                </template>
              </el-table-column>
            </el-table>
          </el-card>
        </el-col>
      </el-row>

      <el-row :gutter="24">
        <el-col :span="6">
          <el-card shadow="never" :class="{ 'editing-card': isEditingMapping }">
            <template #header>
              <b>{{ isEditingMapping ? t.editMapping : t.addMapping }}</b>
              <el-button
                v-if="isEditingMapping"
                size="small"
                style="float: right"
                @click="resetMappingForm"
                >{{ t.cancel }}</el-button
              >
            </template>
            <el-form :model="mappingForm" label-width="60px" size="small">
              <el-form-item :label="t.type">
                <el-radio-group
                  v-model="mappingForm.type"
                  @change="handleMappingTypeChange"
                >
                  <el-radio-button label="tcp">TCP</el-radio-button>
                  <el-radio-button label="socks5">SOCKS5</el-radio-button>
                  <el-radio-button label="http">HTTP</el-radio-button>
                </el-radio-group>
              </el-form-item>

              <el-form-item :label="t.local">
                <el-input-number
                  v-model="mappingForm.local_port"
                  :min="1"
                  :max="65535"
                  style="width: 100%"
                  :disabled="isEditingMapping"
                ></el-input-number>
                <div
                  v-if="isEditingMapping"
                  style="font-size: 10px; color: #909399; line-height: 1"
                >
                  {{ t.editLocalPortNote }}
                </div>
              </el-form-item>

              <template v-if="mappingForm.type === 'tcp'">
                <el-form-item :label="t.remote"
                  ><el-input
                    v-model="mappingForm.remote_host"
                    placeholder="10.x.x.x"
                  ></el-input
                ></el-form-item>
                <el-form-item :label="t.port"
                  ><el-input-number
                    v-model="mappingForm.remote_port"
                    :min="1"
                    :max="65535"
                    style="width: 100%"
                  ></el-input-number
                ></el-form-item>
              </template>
              <template v-else>
                <el-alert
                  :title="t.dynamicTarget"
                  type="info"
                  :closable="false"
                  style="margin-bottom: 18px"
                ></el-alert>
              </template>

              <el-form-item :label="t.chain">
                <el-select
                  v-model="mappingForm.chain"
                  multiple
                  filterable
                  :placeholder="t.selectOrder"
                  style="width: 100%"
                >
                  <el-option
                    v-for="b in bastions"
                    :key="b.name"
                    :label="b.name"
                    :value="b.name"
                  />
                </el-select>
              </el-form-item>
              <el-form-item :label="t.autoStart">
                <el-switch v-model="mappingForm.auto_start"></el-switch>
              </el-form-item>
              <el-form-item>
                <el-button type="primary" @click="addMapping">
                  {{ isEditingMapping ? t.save : t.create }}
                </el-button>
                <el-button @click="resetMappingForm" v-if="!isEditingMapping"
                  >{{ t.reset }}</el-button
                >
              </el-form-item>
            </el-form>
          </el-card>
        </el-col>

        <el-col :span="18">
          <el-card shadow="never">
            <template #header>
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <b>{{ t.mappingList }}</b>
                <div style="display: flex; gap: 10px; align-items: center">
                  <el-switch
                    v-model="autoRefreshMappings"
                    :active-text="currentLang === 'zh' ? '自动刷新' : 'Auto Refresh'"
                    @change="toggleMappingAutoRefresh"
                    style="--el-switch-on-color: #13ce66"
                  />
                  <el-select
                    v-model="refreshInterval"
                    :placeholder="currentLang === 'zh' ? '刷新间隔' : 'Interval'"
                    style="width: 100px"
                    size="small"
                  >
                    <el-option :label="'5s'" :value="5000"></el-option>
                    <el-option :label="'10s'" :value="10000"></el-option>
                    <el-option :label="'30s'" :value="30000"></el-option>
                    <el-option :label="'60s'" :value="60000"></el-option>
                  </el-select>
                </div>
              </div>
            </template>
            <el-table
              :data="mappings"
              size="small"
              style="width: 100%"
              v-loading="loading.maps"
            >
              <el-table-column :label="t.port" width="90">
                <template #default="s"
                  ><b style="color: #409eff"
                    >{{ s.row.local_port }}</b
                  ></template
                >
              </el-table-column>

              <el-table-column :label="t.type" width="70">
                <template #default="s">
                  <el-tag
                    v-if="s.row.type==='socks5'"
                    type="warning"
                    size="small"
                    >S5</el-tag
                  >
                  <el-tag
                    v-else-if="s.row.type==='http'"
                    type="success"
                    size="small"
                    >HTTP</el-tag
                  >
                  <el-tag v-else size="small">TCP</el-tag>
                </template>
              </el-table-column>

              <el-table-column :label="t.autoStart" width="80">
                <template #default="s">
                  <el-switch
                    v-model="s.row.auto_start"
                    @change="toggleAutoStart(s.row)"
                    size="small"
                  ></el-switch>
                </template>
              </el-table-column>

              <el-table-column :label="t.remoteTarget" width="180">
                <template #default="s">
                  <span
                    v-if="s.row.type==='socks5' || s.row.type==='http'"
                    class="muted"
                    ><i>Dynamic</i></span
                  >
                  <span v-else class="code" style="font-size: 12px"
                    >{{ s.row.remote_host }}:{{ s.row.remote_port }}</span
                  >
                </template>
              </el-table-column>

              <el-table-column :label="t.chain" min-width="30%">
                <template #default="s">
                  <el-tag
                    v-for="n in s.row.chain"
                    :key="n"
                    effect="plain"
                    style="margin-right: 2px; zoom: 0.75"
                    >{{ n }}</el-tag
                  >
                </template>
              </el-table-column>

              <el-table-column :label="t.traffic" width="110">
                <template #default="s">
                  <div
                    v-if="s.row.running && trafficStats[s.row.id]"
                    class="traffic-info"
                    style="font-size: 12px"
                  >
                    <div>
                      <span class="traffic-label">↑</span>{{
                      formatBytes(trafficStats[s.row.id].up_bytes) }}
                    </div>
                    <div>
                      <span class="traffic-label">↓</span>{{
                      formatBytes(trafficStats[s.row.id].down_bytes) }}
                    </div>
                  </div>
                  <span v-else class="muted">-</span>
                </template>
              </el-table-column>

              <el-table-column :label="t.operation" width="160" fixed="right">
                <template #default="s">
                  <div style="display: flex; gap: 5px">
                    <el-button
                      size="small"
                      :type="s.row.running ? 'danger' : 'success'"
                      @click="s.row.running ? stopMapping(s.row.id) : startMapping(s.row.id)"
                      circle
                    >
                      <el-icon v-if="s.row.running"><Video-Pause /></el-icon>
                      <el-icon v-else><Video-Play /></el-icon>
                    </el-button>

                    <el-tooltip :content="t.edit" placement="top">
                      <el-button
                        size="small"
                        circle
                        icon="Edit"
                        @click="editMapping(s.row)"
                      ></el-button>
                    </el-tooltip>

                    <el-tooltip :content="t.copy" placement="top">
                      <el-button
                        size="small"
                        circle
                        icon="DocumentCopy"
                        @click="copyMapping(s.row)"
                      ></el-button>
                    </el-tooltip>

                    <el-popconfirm
                      :title="t.deleteConfirm"
                      @confirm="delMapping(s.row.id)"
                    >
                      <template #reference>
                        <el-button
                          size="small"
                          type="danger"
                          circle
                          icon="Delete"
                        ></el-button>
                      </template>
                    </el-popconfirm>
                  </div>
                </template>
              </el-table-column>
            </el-table>
          </el-card>
        </el-col>
      </el-row>

      <!-- 关闭确认对话框 -->
      <el-dialog
        v-model="shutdownDialogVisible"
        :title="t.shutdown"
        width="500px"
      >
        <div style="margin-bottom: 20px">
          <el-alert
            :title="t.shutdownConfirm"
            type="warning"
            :closable="false"
          ></el-alert>
        </div>

        <div v-if="!shutdownCode" style="text-align: center">
          <el-button
            type="primary"
            @click="generateShutdownCode"
            :loading="generating"
          >
            {{ t.generateCode }}
          </el-button>
        </div>

        <div v-else>
          <el-descriptions :column="1" border>
            <el-descriptions-item :label="t.confirmationCode">
              <span
                style="
                  font-size: 24px;
                  font-weight: bold;
                  color: #409eff;
                  font-family: monospace;
                "
                >{{ shutdownCode }}</span
              >
            </el-descriptions-item>
            <el-descriptions-item :label="t.expiresIn">
              <el-tag type="info">{{ shutdownCodeExpiry }}</el-tag>
            </el-descriptions-item>
          </el-descriptions>

          <el-form style="margin-top: 20px" @submit.prevent="verifyAndShutdown">
            <el-form-item :label="t.enterCode">
              <el-input
                v-model="inputCode"
                maxlength="6"
                :placeholder="t.enterCode"
                clearable
              ></el-input>
            </el-form-item>
            <el-form-item>
              <el-button
                type="danger"
                @click="verifyAndShutdown"
                :loading="shuttingDown"
                :disabled="inputCode.length !== 6"
              >
                {{ t.shutdownSystem }}
              </el-button>
              <el-button @click="shutdownDialogVisible = false"
                >{{ t.cancel }}</el-button
              >
            </el-form-item>
          </el-form>
        </div>
      </el-dialog>
    </div>

    <script>
      const API_JSON = (path, method, body) =>
        fetch(`/api${path}`, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        }).then(async (r) => {
          if (!r.ok) throw new Error((await r.json()).detail || r.statusText);
          return r.json();
        });

      const { createApp, ref, onMounted } = Vue;
      const { ElMessage } = ElementPlus;

      const app = createApp({
        setup() {
          const bastions = ref([]);
          const mappings = ref([]);
          const trafficStats = ref({});
          const loading = ref({ maps: false });
          const currentLang = ref(i18n.getLanguage());
          const t = ref(i18n.getAll());

          const updateTitle = () => {
            document.title =
              currentLang.value === "zh"
                ? i18nConfig.zh.titleIndex
                : i18nConfig.en.titleIndex;
          };
          updateTitle();
          const autoRefreshMappings = ref(false);
          const refreshInterval = ref(5000);
          let mappingRefreshInterval = null;
          let trafficRefreshInterval = null;

          // Shutdown dialog
          const shutdownDialogVisible = ref(false);
          const shutdownCode = ref("");
          const shutdownCodeExpiry = ref("");
          const inputCode = ref("");
          const generating = ref(false);
          const shuttingDown = ref(false);
          let expiryTimer = null;

          // 状态管理
          const isEditingBastion = ref(false);
          const editingBastionId = ref(null);
          const isEditingMapping = ref(false);

          // 表单数据
          const defaultBastion = {
            host: "",
            port: 22,
            username: "root",
            password: "",
            pkey_path: "",
          };
          const bastionForm = ref({ ...defaultBastion });

          const portDefaults = { tcp: 1080, socks5: 1080, http: 8000 };
          const defaultMapping = {
            type: "tcp",
            local_host: "127.0.0.1",
            local_port: portDefaults.tcp,
            remote_host: "10.0.0.1",
            remote_port: 22,
            chain: [],
            auto_start: false,
          };
          const mappingForm = ref({ ...defaultMapping });

          const loadBastions = () =>
            fetch("/api/bastions")
              .then((r) => r.json())
              .then((d) => (bastions.value = d));
          const loadMappings = async () => {
            loading.value.maps = true;
            try {
              mappings.value = await fetch("/api/mappings").then((r) =>
                r.json()
              );
              if (mappings.value.length > 0) loadStats();
            } finally {
              loading.value.maps = false;
            }
          };
          const loadStats = async () => {
            // 检查是否有运行中的映射
            if (!mappings.value || mappings.value.length === 0) return;
            const hasRunning = mappings.value.some((m) => m.running);
            if (!hasRunning) return;

            try {
              const stats = await fetch("/api/stats").then((r) => r.json());
              trafficStats.value = stats;
            } catch (e) {
              // Silently handle stats loading errors
            }
          };

          // --- Bastion Logic ---
          const resetBastionForm = () => {
            bastionForm.value = { ...defaultBastion };
            isEditingBastion.value = false;
            editingBastionId.value = null;
          };

          const submitBastion = async () => {
            try {
              if (isEditingBastion.value) {
                // 修改
                await API_JSON(
                  `/bastions/${editingBastionId.value}`,
                  "PUT",
                  bastionForm.value
                );
                ElMessage.success(t.value.editSuccess);
              } else {
                // 新增
                await API_JSON("/bastions", "POST", bastionForm.value);
                ElMessage.success(t.value.addSuccess);
              }
              resetBastionForm();
              loadBastions();
            } catch (e) {
              ElMessage.error(e.message);
            }
          };

          const editBastion = (row) => {
            // 深拷贝数据到表单
            bastionForm.value = JSON.parse(JSON.stringify(row));
            isEditingBastion.value = true;
            editingBastionId.value = row.id;
          };

          const copyBastion = (row) => {
            // 复制：填充数据，但是状态保持为“新增”
            bastionForm.value = JSON.parse(JSON.stringify(row));
            delete bastionForm.value.id; // 清除 ID，视为新对象
            isEditingBastion.value = false;
            ElMessage.info(t.value.configCopied);
          };

          const delBastion = async (id) => {
            await fetch(`/api/bastions/${id}`, { method: "DELETE" });
            if (editingBastionId.value === id) resetBastionForm();
            loadBastions();
          };

          // --- Mapping Logic ---
          const resetMappingForm = () => {
            mappingForm.value = { ...defaultMapping };
            isEditingMapping.value = false;
          };

          const handleMappingTypeChange = (value) => {
            if (!isEditingMapping.value && portDefaults[value]) {
              mappingForm.value.local_port = portDefaults[value];
            }
            if (value !== "tcp") {
              mappingForm.value.remote_host = "0.0.0.0";
              mappingForm.value.remote_port = 0;
            }
          };

          const addMapping = async () => {
            try {
              if (
                mappingForm.value.type === "socks5" ||
                mappingForm.value.type === "http"
              ) {
                mappingForm.value.remote_host = "0.0.0.0";
                mappingForm.value.remote_port = 0;
              }
              // Mappings 的 POST 本身支持 Upsert (如果 local_host:port 相同则更新)
              await API_JSON("/mappings", "POST", mappingForm.value);
              await loadMappings();
              ElMessage.success(
                isEditingMapping.value
                  ? t.value.mappingSaved
                  : t.value.mappingCreated
              );
              resetMappingForm();
            } catch (e) {
              ElMessage.error(e.message);
            }
          };

          const editMapping = (row) => {
            mappingForm.value = JSON.parse(JSON.stringify(row));
            // 将 remote_host/port 转回数字（如果是字符串）
            isEditingMapping.value = true;
          };

          const copyMapping = (row) => {
            mappingForm.value = JSON.parse(JSON.stringify(row));
            // 清除 ID，让后端生成新的 ID
            delete mappingForm.value.id;
            // 复制时，通常需要改端口，防止冲突，所以保持"新增"状态
            // 自动端口 +1 以示区别？
            mappingForm.value.local_port += 1;
            isEditingMapping.value = false;
            ElMessage.info(t.value.configCopiedPortIncremented);
          };

          const delMapping = async (id) => {
            await fetch(`/api/mappings/${id}`, { method: "DELETE" });
            loadMappings();
          };
          const startMapping = async (id) => {
            try {
              await API_JSON(`/mappings/${id}/start`, "POST");
              loadMappings();
            } catch (e) {
              ElMessage.error(e.message);
            }
          };
          const stopMapping = async (id) => {
            await API_JSON(`/mappings/${id}/stop`, "POST");
            loadMappings();
          };

          const toggleAutoStart = async (row) => {
            try {
              await API_JSON("/mappings", "POST", row);
              ElMessage.success(t.value.autoStartUpdated);
            } catch (e) {
              ElMessage.error(e.message);
              row.auto_start = !row.auto_start; // 回滚
            }
          };

          const formatBytes = (b) => {
            if (b === 0) return "0";
            const i = Math.floor(Math.log(b) / Math.log(1024));
            return (b / Math.pow(1024, i)).toFixed(1) + ["B", "K", "M", "G"][i];
          };

          const refreshPage = () => {
            window.location.reload();
          };

          const toggleMappingAutoRefresh = (enabled) => {
            if (enabled) {
              startMappingAutoRefresh();
            } else {
              stopMappingAutoRefresh();
            }
          };

          const startMappingAutoRefresh = () => {
            stopMappingAutoRefresh(); // 清除旧的定时器

            // 刷新映射列表
            mappingRefreshInterval = setInterval(async () => {
              await loadMappings();
            }, refreshInterval.value);

            // 更频繁地刷新流量统计（每2秒）
            trafficRefreshInterval = setInterval(async () => {
              await loadStats();
            }, 2000);
          };

          const stopMappingAutoRefresh = () => {
            if (mappingRefreshInterval) {
              clearInterval(mappingRefreshInterval);
              mappingRefreshInterval = null;
            }
            if (trafficRefreshInterval) {
              clearInterval(trafficRefreshInterval);
              trafficRefreshInterval = null;
            }
          };

          onMounted(async () => {
            loadBastions();
            await loadMappings();
            // 初始加载统计信息
            loadStats();
          });

          // 监听刷新间隔变化，重启自动刷新
          const { watch } = Vue;
          watch(
            () => refreshInterval.value,
            () => {
              if (autoRefreshMappings.value) {
                startMappingAutoRefresh();
              }
            }
          );

          const goToLogs = () => {
            window.location.href = "/web/logs.html";
          };

          const goToErrors = () => {
            window.location.href = "/web/errors.html";
          };

          const switchLanguage = (lang) => {
            updateTitle();
            i18n.setLanguage(lang);
            currentLang.value = lang;
            t.value = i18n.getAll();
          };

          const showShutdownDialog = () => {
            shutdownDialogVisible.value = true;
            shutdownCode.value = "";
            inputCode.value = "";
          };

          const generateShutdownCode = async () => {
            generating.value = true;
            try {
              const response = await fetch("/api/shutdown/generate-code", {
                method: "POST",
              });
              const data = await response.json();
              shutdownCode.value = data.code;

              // 计算过期时间
              const expiresAt = new Date(data.expires_at * 1000);
              updateExpiry(expiresAt);

              // 启动倒计时
              if (expiryTimer) clearInterval(expiryTimer);
              expiryTimer = setInterval(() => updateExpiry(expiresAt), 1000);

              ElMessage.success(t.value.codeGenerated);
            } catch (e) {
              ElMessage.error(e.message);
            } finally {
              generating.value = false;
            }
          };

          const updateExpiry = (expiresAt) => {
            const now = new Date();
            const diff = Math.floor((expiresAt - now) / 1000);
            if (diff <= 0) {
              shutdownCodeExpiry.value = t.value.codeExpired;
              if (expiryTimer) {
                clearInterval(expiryTimer);
                expiryTimer = null;
              }
            } else {
              const minutes = Math.floor(diff / 60);
              const seconds = diff % 60;
              shutdownCodeExpiry.value = `${minutes}:${seconds
                .toString()
                .padStart(2, "0")}`;
            }
          };

          const verifyAndShutdown = async () => {
            if (inputCode.value.length !== 6) {
              ElMessage.warning(t.value.enterCode);
              return;
            }

            shuttingDown.value = true;
            try {
              const response = await fetch("/api/shutdown/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ code: inputCode.value }),
              });

              const data = await response.json();

              if (response.ok) {
                ElMessage.success(t.value.shutdownInitiated);
                shutdownDialogVisible.value = false;
                if (expiryTimer) clearInterval(expiryTimer);
              } else {
                ElMessage.error(data.detail || t.value.invalidCode);
              }
            } catch (e) {
              ElMessage.error(e.message);
            } finally {
              shuttingDown.value = false;
            }
          };

          return {
            bastions,
            mappings,
            trafficStats,
            loading,
            bastionForm,
            mappingForm,
            isEditingBastion,
            isEditingMapping,
            submitBastion,
            delBastion,
            editBastion,
            copyBastion,
            resetBastionForm,
            addMapping,
            delMapping,
            startMapping,
            stopMapping,
            editMapping,
            copyMapping,
            resetMappingForm,
            toggleAutoStart,
            formatBytes,
            goToLogs,
            goToErrors,
            currentLang,
            t,
            switchLanguage,
            autoRefreshMappings,
            refreshInterval,
            refreshPage,
            toggleMappingAutoRefresh,
            shutdownDialogVisible,
            shutdownCode,
            shutdownCodeExpiry,
            inputCode,
            generating,
            shuttingDown,
            showShutdownDialog,
            generateShutdownCode,
            verifyAndShutdown,
          };
        },
      });

      for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
        app.component(key, component);
      }
      app.use(ElementPlus).mount("#app");
    </script>
  </body>
</html>
